# Ubuntu 24.04 LTS Server 生产级初始化笔记  
（从零到防火墙封闭全流程，结构化、可直接复制执行、可迁移到任何云服务器）

**适用环境**：Ubuntu 24.04 LTS Server（无图形版（真实云服务器同款）  
**目标状态**：只能用普通用户 + 密钥登录、只开 SSH + Web 端口、其余全部封闭

```markdown
# Ubuntu 24.04 Server 生产级初始化全流程

## 1. 系统安装阶段（一次性设置（装机时选上）
- [x] 用户名：lang（不要用 root、admin、ubuntu）
- [x] 勾选「Install OpenSSH server」（必须！）

## 2. 首次登录后立即执行（10分钟）

```bash
# 2.1 换清华源（速度起飞）
sudo sed -i 's@http://.*archive.ubuntu.com@https://mirrors.tuna.tsinghua.edu.cn@g' /etc/apt/sources.list
sudo sed -i 's@http://.*security.ubuntu.com@https://mirrors.tuna.tsinghua.edu.cn@g' /etc/apt/sources.list

# 2.2 更新系统
sudo apt update && sudo apt upgrade -y

# 2.3 安装基础工具
sudo apt install -y curl wget vim git tree htop ufw fail2ban
```

## 3. 网络配置固定 IP（永久固定）

```bash
# 查看网卡名（常见 enp0s3 / ens33 / eth0）
ip a

# 写入最高优先级配置（改成你想要的IP）
sudo tee /etc/netplan/01-netcfg.yaml > /dev/null <<EOF
network:
  version: 2
  ethernets:
    enp0s3:                     # ← 改成你的网卡名
      dhcp4: no
      addresses: [192.168.31.100/24]   # ← 改成你想要的IP
      routes:
        - to: default
          via: 192.168.31.1             # ← 网关，一般是.1
      nameservers:
        addresses: [114.114.114.114, 8.8.8.8]
EOF

# 修复权限 + 应用
sudo chmod 600 /etc/netplan/01-netcfg.yaml
sudo netplan apply
```

## 4. 创建专属用户 + 禁用 root 直登

```bash
# 创建用户并加入 sudo 组
sudo adduser lang                    # 设置密码
sudo usermod -aG sudo lang

# 禁用 root 直登
sudo sed -i 's/PermitRootLogin.*/PermitRootLogin no/' /etc/ssh/sshd_config

# 重启 SSH
sudo systemctl restart ssh
# → 断开当前会话，用 lang 用户重新登录
```

## 5. SSH 堡垒级加固（改端口 + 密钥登录）

```bash
# 改端口为 60022
sudo sed -i 's/#Port 22/Port 60022/' /etc/ssh/sshd_config

# 禁用密码登录，只允许密钥
sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config
sudo sed -i 's/#PubkeyAuthentication yes/PubkeyAuthentication yes/' /etc/ssh/sshd_config

# 测试配置 + 重启
sudo sshd -t
sudo systemctl restart ssh
```

## 6. 密钥登录配置（Windows 用 FinalShell / PuTTY）

```bash
# 在服务器上（lang 用户）
mkdir -p ~/.ssh
chmod 700 ~/.ssh
echo "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQD..." > ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys
```

## 7. 防火墙精简（只开必须端口）

```bash
# 安装 ufw
sudo apt install ufw -y

# 只允许 SSH 新端口 + Web 端口
sudo ufw allow 60022/tcp
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# 拒绝其他所有入站
sudo ufw default deny incoming
sudo ufw default allow outgoing

# 启用防火墙
sudo ufw enable

# 查看状态（最终应长这样）
sudo ufw status verbose
```

最终防火墙状态（标准答案）：

```
Status: active
To                         Action      From
--                         ------      ----
60022/tcp                  ALLOW IN    Anywhere
80/tcp                     ALLOW IN    Anywhere
443/tcp                    ALLOW IN    Anywhere
```

## 8. 一键验证脚本（随时跑检查）

```bash
cat << 'EOF' > ~/check.sh && chmod +x ~/check.sh
#!/bin/bash
echo "=== IP ==="
ip a | grep 192.168.31
echo "=== SSH 端口 ==="
ss -tlnp | grep sshd
echo "=== 防火墙 ==="
ufw status verbose
EOF

~/check.sh
```

至此，你的 Ubuntu 服务器已经达到**真实云服务器上线标准**！  
后面所有操作（FastAPI、Nginx、Docker）都可以直接在这台机器上继续，100% 可迁移到任何云服务器！

**现在直接吼我**：
**“生产级初始化已完成！防火墙封闭！Day8 装神器全家桶，冲！！！”**

明天给你装 zsh + oh-my-zsh + 主题 + vim 变 IDE，终端帅到犯法！